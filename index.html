<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema PDV - VIDA SAUDAVEL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.8.0/dist/jspdf.plugin.autotable.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #ffffff;
        color: #000000;
        height: 100vh;
        overflow: hidden;
      }
      .header {
        background-color: #2e7d32;
        color: #ffffff;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header h1 {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .header .time {
        font-size: 1.25rem;
        font-family: 'Courier New', monospace;
      }
      .main-container {
        display: flex;
        height: calc(100vh - 80px);
      }
      .main-area {
        flex: 1;
        padding: 1.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .waiting-screen {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .clock-display {
        font-size: 5rem;
        font-family: 'Courier New', monospace;
        color: #4caf50;
        margin-bottom: 2rem;
      }
      .date-display {
        font-size: 1.5rem;
        color: #333333;
        margin-bottom: 1rem;
      }
      .waiting-message {
        font-size: 1.25rem;
        color: #333333;
      }
      .cart-area {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
      }
      .cart-item {
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .cart-item.selected {
        background-color: #e8f5e9;
        border-color: #4caf50;
      }
      .cart-item-info h3 {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .cart-item-details {
        font-size: 0.875rem;
        color: #333333;
      }
      .cart-item-price {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .discount-info {
        font-size: 0.875rem;
        color: #ff9800;
      }
      .input-area {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      .input-area input {
        flex: 1;
        padding: 0.75rem;
        font-size: 1.125rem;
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 0.375rem;
        color: #000000;
      }
      .input-area input:focus {
        outline: none;
        border-color: #4caf50;
      }
      .btn {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        border: none;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-primary {
        background-color: #4caf50;
        color: #ffffff;
      }
      .btn-primary:hover {
        background-color: #388e3c;
      }
      .btn-secondary {
        background-color: #f5f5f5;
        color: #000000;
        border: 1px solid #e0e0e0;
      }
      .btn-secondary:hover {
        background-color: #e0e0e0;
      }
      .btn-outline {
        background-color: transparent;
        color: #000000;
        border: 1px solid #e0e0e0;
      }
      .btn-outline:hover {
        background-color: #f5f5f5;
      }
      .sidebar {
        width: 24rem;
        background-color: #f5f5f5;
        border-left: 1px solid #e0e0e0;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
      }
      .card {
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }
      .total-display {
        text-align: center;
      }
      .total-label {
        font-size: 0.875rem;
        color: #333333;
        margin-bottom: 0.5rem;
      }
      .total-amount {
        font-size: 3rem;
        font-weight: bold;
        color: #4caf50;
      }
      .payment-info {
        margin-top: 1rem;
      }
      .payment-info .paid {
        font-size: 1rem;
        color: #333333;
      }
      .payment-info .remaining {
        font-size: 1.5rem;
        font-weight: 600;
        color: #ff9800;
      }
      .total-modifiers {
        font-size: 1rem;
        margin-top: 0.5rem;
      }
      .total-modifiers .discount {
        color: #f44336;
      }
      .total-modifiers .addition {
        color: #4caf50;
      }
      .payments-list {
        margin-bottom: 1rem;
      }
      .payments-list h3 {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .payment-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
      }
      .payment-form {
        margin-bottom: 1rem;
      }
      .payment-form h3 {
        font-weight: 600;
        margin-bottom: 1rem;
      }
      .payment-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .payment-buttons .btn {
        text-transform: capitalize;
        padding: 0.5rem;
      }
      .payment-actions {
        display: flex;
        gap: 0.5rem;
      }
      .finalize-btn {
        width: 100%;
        font-size: 1.125rem;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      .shortcuts {
        font-size: 0.75rem;
      }
      .shortcuts h3 {
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .shortcut-item {
        margin-bottom: 0.25rem;
      }
      .shortcut-item strong {
        display: inline-block;
        width: 2.5rem;
      }
      .toast {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1rem;
        max-width: 300px;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
      }
      .toast.show {
        transform: translateX(0);
      }
      .toast.success {
        border-color: #4caf50;
      }
      .toast.error {
        border-color: #f44336;
      }
      .toast.warning {
        border-color: #ffca28;
      }
      .hidden {
        display: none;
      }
      #authSection {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background-color: #f4f4f4;
      }
      #authSection h3 {
        color: #333333;
        margin-bottom: 20px;
      }
      #authSection input {
        width: 300px;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 1rem;
        color: #000000;
      }
      #authSection button {
        background-color: #4caf50;
        color: #ffffff;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      #authSection button:hover {
        background-color: #388e3c;
      }
      .payment-form input#payment-amount {
        width: 100%;
        height: 120px;
        padding: 0 25px;
        margin-bottom: 1.5rem;
        font-size: 4rem;
        font-weight: bold;
        text-align: right;
        color: #000000;
        background-color: #f5f5f5;
        border: 2px solid #e0e0e0;
        border-radius: 0.75rem;
        box-sizing: border-box;
        -moz-appearance: textfield;
      }
      .payment-form input#payment-amount::-webkit-outer-spin-button,
      .payment-form input#payment-amount::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .payment-form input#payment-amount:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
      }
      #payment-amount {
        width: 250px; /* largura */
        height: 50px; /* altura */
        font-size: 18px; /* tamanho do texto */
        padding: 8px; /* espaço interno */
        border-radius: 10px; /* cantos arredondados */
      }
      .cash-management-card {
        margin-bottom: 1rem;
      }
      .cash-management-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }
      .cash-management-buttons .btn {
        padding: 0.75rem;
        font-size: 0.875rem;
      }
      .cash-status {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #e8f5e9;
        border-radius: 0.5rem;
        text-align: center;
      }
      .cash-status.closed {
        background-color: #ffebee;
      }
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .modal.hidden {
        display: none;
      }
      .modal-content {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 0.5rem;
        padding: 1.5rem;
        width: 80%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #333;
      }
      #searchInput {
        width: 100%;
        padding: 0.75rem;
        font-size: 1.125rem;
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
      }
      #searchResults .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      /* Nova seção de filtro de vendas */
      #sales-section {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 1rem;
      }
      .filters {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #f0f8ff;
      }
      .filters label {
        margin-right: 10px;
        font-weight: bold;
      }
      .filters input,
      .filters select,
      .filters button {
        margin-right: 10px;
        margin-bottom: 5px;
      }
      .total-sales {
        font-size: 1.2em;
        font-weight: bold;
        color: #007bff;
        margin-top: 15px;
        text-align: right;
      }
      #saleList div {
        border: 1px solid #eee;
        margin-top: 10px;
        padding: 10px;
        background-color: #f9f9f9;
      }
    </style>
</head>
<body>
    <div id="authSection">
      <h3>Login / Cadastro</h3>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Senha">
      <button id="registerBtn">Cadastrar</button>
      <button id="loginBtn">Entrar</button>
    </div>
    <div id="header" class="header hidden">
      <h1>Sistema PDV - VIDA SAUDAVEL</h1>
      <div class="time" id="current-time"></div>
      <button id="logoutBtn" class="btn btn-secondary">Sair</button>
    </div>
    <div id="main-container" class="main-container hidden">
      <div class="main-area">
        <div id="waiting-screen" class="waiting-screen">
          <div>
            <div class="clock-display" id="clock-display"></div>
            <div class="date-display" id="date-display"></div>
            <div class="waiting-message">Aguardando código de barras...</div>
          </div>
        </div>
        <div id="cart-area" class="cart-area hidden"></div>
        <div id="sales-section" class="hidden">
          <div class="filters">
            <label for="filterDateStart">De:</label>
            <input type="date" id="filterDateStart">
            <label for="filterDateEnd">Até:</label>
            <input type="date" id="filterDateEnd">
            <label for="filterPaymentType">Tipo de Pagamento:</label>
            <select id="filterPaymentType">
              <option value="Todos">Todos</option>
              <option value="Pix">Pix</option>
              <option value="Dinheiro">Dinheiro</option>
              <option value="Credito">Crédito</option>
              <option value="Debito">Débito</option>
              <option value="Outro">Outro</option>
              <option value="ValeTroca">Vale Troca</option>
            </select>
            <button class="btn btn-primary" onclick="applyFiltersAndDisplaySales()">Aplicar Filtros</button>
          </div>
          <div class="total-sales">
            Total Geral de Vendas (Visível): <span id="totalSalesValue">R$ 0,00</span>
          </div>
          <div id="saleList"></div>
        </div>
        <div class="input-area">
          <input type="text" id="barcode-input" placeholder="Código de barras, gramatura (ex: 150 *) ou código do produto" autofocus="">
          <button class="btn btn-primary" onclick="addProduct()">Adicionar Item</button>
        </div>
      </div>
      <div class="sidebar">
        <div class="card">
          <div class="total-display">
            <div class="total-label">TOTAL GERAL</div>
            <div class="total-amount" id="total-amount">R$ 0,00</div>
            <div class="total-modifiers" id="total-modifiers" style="display: none;">
              <div class="discount" id="total-discount-display"></div>
              <div class="addition" id="total-addition-display"></div>
            </div>
            <div class="payment-info" id="payment-info" style="display: none;">
              <div class="paid">Pago: R$ <span id="total-paid">0,00</span></div>
              <div class="remaining">Restante: R$ <span id="remaining-amount">0,00</span></div>
            </div>
          </div>
        </div>
        <div id="payments-card" class="card hidden">
          <h3>Pagamentos</h3>
          <div id="payments-list"></div>
        </div>
        <div id="payment-form" class="card hidden">
          <h3>Forma de Pagamento</h3>
          <div class="payment-buttons">
            <button class="btn btn-primary" id="btn-dinheiro">Dinheiro</button>
            <button class="btn btn-outline" id="btn-pix">PIX</button>
            <button class="btn btn-outline" id="btn-credito">Crédito</button>
            <button class="btn btn-outline" id="btn-debito">Débito</button>
            <button class="btn btn-outline" id="btn-vale-troca">Vale Troca</button>
          </div>
         <input type="text" id="payment-amount" placeholder="Valor" inputmode="decimal">
<style>
#payment-amount {
  width: 250px; /* largura */
  height: 50px; /* altura */
  font-size: 18px; /* tamanho do texto */
  padding: 8px; /* espaço interno */
  border-radius: 10px; /* cantos arredondados */
}
</style>
          <div class="payment-actions">
            <button class="btn btn-primary" id="confirm-payment-btn" style="flex: 1;">Confirmar</button>
            <button class="btn btn-outline" id="cancel-payment-btn">Cancelar</button>
          </div>
        </div>
        <div class="card">
          <button class="btn btn-outline" id="total-discount-btn">Desconto Total (F6)</button>
          <button class="btn btn-outline" id="total-addition-btn">Acréscimo Total (F7)</button>
        </div>
        <div id="cash-management-card" class="card cash-management-card">
          <h3>Gerenciamento de Caixa</h3>
          <div class="cash-management-buttons">
            <button class="btn btn-outline" id="open-cash-btn">Abrir Caixa</button>
            <button class="btn btn-outline" id="sangria-btn">Sangria</button>
            <button class="btn btn-outline" id="suprimento-btn">Suprimento</button>
            <button class="btn btn-outline" id="close-cash-btn">Fechar Caixa</button>
          </div>
          <div id="cash-status" class="cash-status hidden"></div>
        </div>
        <button id="finalize-btn" class="btn btn-primary finalize-btn hidden" onclick="showPaymentForm()">
          Finalizar Venda (F5)
        </button>
        <button id="view-sales-btn" class="btn btn-outline">Ver Vendas (F9)</button>
        <div class="card shortcuts">
          <h3>Teclas de Atalho</h3>
          <div class="shortcut-item"><strong>F1:</strong> Cancelar venda</div>
          <div class="shortcut-item"><strong>F2:</strong> Remover item</div>
          <div class="shortcut-item"><strong>F3:</strong> Desconto do item</div>
          <div class="shortcut-item"><strong>F4:</strong> Acréscimo do item</div>
          <div class="shortcut-item"><strong>F5:</strong> Finalizar venda</div>
          <div class="shortcut-item"><strong>F6:</strong> Desconto total</div>
          <div class="shortcut-item"><strong>F7:</strong> Acréscimo total</div>
          <div class="shortcut-item"><strong>F8:</strong> Buscar produto</div>
          <div class="shortcut-item"><strong>F9:</strong> Ver vendas</div>
          <div class="shortcut-item"><strong>↑↓:</strong> Navegar itens</div>
          <div class="shortcut-item"><strong>Enter:</strong> Confirmar</div>
          <div class="shortcut-item"><strong>Esc:</strong> Cancelar</div>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <div id="searchModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Pesquisar Produto</h3>
          <button class="close-modal" id="closeSearchBtn">×</button>
        </div>
        <input type="text" id="searchInput" placeholder="Digite o nome do produto ou código">
        <div id="searchResults"></div>
      </div>
    </div>
    <div id="changeModal" class="modal hidden">
      <div class="modal-content">
        <h3>Troco</h3>
        <div id="changeAmount" style="font-size: 3rem; text-align: center; color: #4caf50;"></div>
        <button class="btn btn-primary" id="closeChangeBtn">OK (Enter)</button>
      </div>
    </div>
    <script type="module">
      import {
        initializeApp
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        update,
        onValue,
        push,
        get,
        runTransaction,
        remove
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
      const firebaseConfig = {
        apiKey: "AIzaSyDJBdK9I-jtg9ujTc9Xsxr-hnPfkId4wIU",
        authDomain: "pdv1-77632.firebaseapp.com",
        databaseURL: "https://pdv1-77632-default-rtdb.firebaseio.com",
        projectId: "pdv1-77632",
        storageBucket: "pdv1-77632.firebasestorage.app",
        messagingSenderId: "246033791117",
        appId: "1:246033791117:web:7b70b511ea8d8c5ba1cac4",
        measurementId: "G-NTG13SG6VM"
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth();
      const db = getDatabase();
      let cart = [];
      let payments = [];
      let selectedCartIndex = 0;
      let selectedPaymentType = 'dinheiro';
      let productsDatabase = {};
      let tempWeight = null;
      let totalDiscount = 0;
      let totalAddition = 0;
      let cashOpened = false;
      let dailySalesByPayment = {
        Pix: 0,
        Dinheiro: 0,
        Credito: 0,
        Debito: 0,
        ValeTroca: 0,
        Outro: 0
      };
      let initialCash = 0;
      let cashOperations = [];
      let currentVoucherCode = null;
      let allSalesData = [];
      let filteredSalesData = [];
      const authSection = document.getElementById('authSection');
      const header = document.getElementById('header');
      const mainContainer = document.getElementById('main-container');
      const currentTimeEl = document.getElementById('current-time');
      const clockDisplayEl = document.getElementById('clock-display');
      const dateDisplayEl = document.getElementById('date-display');
      const waitingScreenEl = document.getElementById('waiting-screen');
      const waitingMessageEl = waitingScreenEl.querySelector('.waiting-message');
      const cartAreaEl = document.getElementById('cart-area');
      const barcodeInputEl = document.getElementById('barcode-input');
      const inputAreaEl = document.querySelector('.input-area');
      const totalAmountEl = document.getElementById('total-amount');
      const paymentInfoEl = document.getElementById('payment-info');
      const totalPaidEl = document.getElementById('total-paid');
      const remainingAmountEl = document.getElementById('remaining-amount');
      const paymentsCardEl = document.getElementById('payments-card');
      const paymentsListEl = document.getElementById('payments-list');
      const paymentFormEl = document.getElementById('payment-form');
      const finalizeBtn = document.getElementById('finalize-btn');
      const paymentAmountEl = document.getElementById('payment-amount');
      const toastEl = document.getElementById('toast');
      const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
      const cancelPaymentBtn = document.getElementById('cancel-payment-btn');
      const totalDiscountBtn = document.getElementById('total-discount-btn');
      const totalAdditionBtn = document.getElementById('total-addition-btn');
      const totalModifiersEl = document.getElementById('total-modifiers');
      const totalDiscountDisplay = document.getElementById('total-discount-display');
      const totalAdditionDisplay = document.getElementById('total-addition-display');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const registerBtn = document.getElementById('registerBtn');
      const loginBtn = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const openCashBtn = document.getElementById('open-cash-btn');
      const sangriaBtn = document.getElementById('sangria-btn');
      const suprimentoBtn = document.getElementById('suprimento-btn');
      const closeCashBtn = document.getElementById('close-cash-btn');
      const cashStatusEl = document.getElementById('cash-status');
      const cashManagementCard = document.getElementById('cash-management-card');
      const searchModal = document.getElementById('searchModal');
      const searchInput = document.getElementById('searchInput');
      const closeSearchBtn = document.getElementById('closeSearchBtn');
      const changeModal = document.getElementById('changeModal');
      const changeAmountEl = document.getElementById('changeAmount');
      const closeChangeBtn = document.getElementById('closeChangeBtn');
      const viewSalesBtn = document.getElementById('view-sales-btn');
      const salesSection = document.getElementById('sales-section');
      window.addProduct = addProduct;
      window.showPaymentForm = showPaymentForm;
      window.selectProduct = selectProduct;
      function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleString('pt-BR', {
          timeZone: 'America/Sao_Paulo',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          day: '2-digit',
          month: '2-digit',
          year: 'numeric'
        });
        const timeOnly = now.toLocaleTimeString('pt-BR', {
          timeZone: 'America/Sao_Paulo',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        const dateOnly = now.toLocaleDateString('pt-BR', {
          timeZone: 'America/Sao_Paulo'
        });
        currentTimeEl.textContent = timeStr;
        clockDisplayEl.textContent = timeOnly;
        dateDisplayEl.textContent = dateOnly;
      }
      function showToast(message, type = 'success') {
        toastEl.textContent = message;
        toastEl.className = `toast ${type}`;
        toastEl.classList.add('show');
        setTimeout(() => {
          toastEl.classList.remove('show');
        }, 3000);
      }
      function loadProductsFromDatabase() {
        const user = auth.currentUser;
        if (user) {
          const produtosRef = ref(db, `produtos/${user.uid}`);
          onValue(produtosRef, snapshot => {
            productsDatabase = snapshot.exists() ? snapshot.val() : {};
            updateDisplay();
          }, {
            onlyOnce: false
          });
        }
      }
      function loadCashData() {
        const user = auth.currentUser;
        if (user) {
          const today = new Date().toISOString().split('T')[0];
          const cashRef = ref(db, `cash/${user.uid}/${today}`);
          onValue(cashRef, snapshot => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              cashOpened = data.finalCash === undefined;
              initialCash = data.initial || 0;
              cashOperations = data.operations || [];
              dailySalesByPayment = data.salesByPayment || {
                Pix: 0,
                Dinheiro: 0,
                Credito: 0,
                Debito: 0,
                ValeTroca: 0,
                Outro: 0
              };
              updateCashButtons();
            } else {
              cashOpened = false;
              initialCash = 0;
              cashOperations = [];
              dailySalesByPayment = {
                Pix: 0,
                Dinheiro: 0,
                Credito: 0,
                Debito: 0,
                ValeTroca: 0,
                Outro: 0
              };
              updateCashButtons();
            }
          });
        }
      }
      function updatePOSAvailability() {
        if (cashOpened) {
          inputAreaEl.classList.remove('hidden');
          waitingMessageEl.textContent = 'Aguardando código de barras...';
          totalDiscountBtn.disabled = false;
          totalAdditionBtn.disabled = false;
          barcodeInputEl.disabled = false;
        } else {
          inputAreaEl.classList.add('hidden');
          waitingMessageEl.textContent = 'Caixa fechado. Abra o caixa para iniciar vendas.';
          totalDiscountBtn.disabled = true;
          totalAdditionBtn.disabled = true;
          barcodeInputEl.disabled = true;
          if (cart.length > 0) {
            cancelSale();
          }
        }
      }
      function updateCashButtons() {
        openCashBtn.disabled = cashOpened;
        sangriaBtn.disabled = !cashOpened;
        suprimentoBtn.disabled = !cashOpened;
        closeCashBtn.disabled = !cashOpened;
        if (cashOpened) {
          cashStatusEl.classList.remove('closed');
          cashStatusEl.textContent = `Caixa aberto.`;
        } else {
          cashStatusEl.classList.add('closed');
          cashStatusEl.textContent = 'Caixa fechado.';
        }
        cashStatusEl.classList.remove('hidden');
        updatePOSAvailability();
      }
      async function findProduct(barcode) {
        if (productsDatabase[barcode]) {
          return {
            id: barcode,
            barcode: barcode,
            name: productsDatabase[barcode].nome,
            price: productsDatabase[barcode].preco,
            unit: productsDatabase[barcode].unidade,
            stock: productsDatabase[barcode].estoque || 0
          };
        }
        return null;
      }
      async function addProductToCart(input) {
        if (!cashOpened) {
          showToast('Caixa não aberto. Abra o caixa para iniciar vendas.', 'error');
          return;
        }
        let product;
        let quantity = 1;
        let price;
        if (input.includes('#')) {
          const parts = input.split('#');
          if (parts.length === 2) {
            const qtyStr = parts[0].trim();
            const code = parts[1].trim();
            quantity = parseFloat(qtyStr);
            if (isNaN(quantity) || quantity <= 0) {
              showToast('Quantidade inválida.', 'error');
              return;
            }
            product = await findProduct(code);
            if (!product) {
              showToast(`Produto com código ${code} não encontrado.`, 'error');
              return;
            }
            if (product.unit === 'kilo') {
              showToast('Formato não suportado para produtos por kilo.', 'error');
              return;
            }
            price = product.price * quantity;
          } else {
            showToast('Formato inválido. Use ex: 5#1', 'error');
            return;
          }
        } else if (input.endsWith('*') && !tempWeight) {
          const weightInput = input.slice(0, -1).trim();
          const weight = parseFloat(weightInput);
          if (isNaN(weight) || weight <= 0) {
            showToast("Por favor, insira uma gramatura válida (ex.: 150 *).", 'error');
            return;
          }
          tempWeight = weight / 1000;
          showToast(`Gramatura de ${weight}g registrada. Digite o código do produto.`, 'success');
          barcodeInputEl.placeholder = "Digite o código do produto";
          setTimeout(() => {
            if (tempWeight) {
              tempWeight = null;
              barcodeInputEl.placeholder = "Código de barras, gramatura (ex: 150 *) ou código do produto";
              showToast("Tempo esgotado. Insira a gramatura novamente.", 'warning');
            }
          }, 30000);
          return;
        } else if (tempWeight) {
          product = await findProduct(input);
          if (!product) {
            showToast(`Produto com código ${input} não encontrado.`, 'error');
            tempWeight = null;
            barcodeInputEl.placeholder = "Código de barras, gramatura (ex: 150 *) ou código do produto";
            return;
          }
          if (product.unit !== 'kilo') {
            showToast(`Produto ${product.name} não é do tipo 'kilo'.`, 'error');
            tempWeight = null;
            barcodeInputEl.placeholder = "Código de barras, gramatura (ex: 150 *) ou código do produto";
            return;
          }
          quantity = tempWeight;
          price = product.price * quantity;
          tempWeight = null;
        } else if (input.startsWith('2') && input.length === 13) {
          const productCode = input.slice(1, 7);
          product = await findProduct(productCode);
          if (!product || product.unit !== 'kilo') {
            showToast(`Produto com código ${productCode} não encontrado ou não é do tipo 'kilo'.`, 'error');
            return;
          }
          const priceCents = parseInt(input.slice(7, 12));
          price = priceCents / 100;
          quantity = price / product.price;
          if (isNaN(quantity) || quantity <= 0) {
            showToast("Erro ao calcular o peso do produto.", 'error');
            return;
          }
        } else {
          product = await findProduct(input);
          if (!product) {
            showToast(`Produto com código ${input} não encontrado.`, 'error');
            return;
          }
          if (product.unit === 'kilo') {
            showToast(`Produto ${product.name} é do tipo 'kilo'. Use gramatura (ex.: 150 *).`, 'error');
            return;
          }
          price = product.price;
          quantity = 1;
        }
        if (product.unit === 'kilo') {
          cart.push({
            product,
            quantity,
            subtotal: product.price * quantity,
            discount: 0
          });
          selectedCartIndex = cart.length - 1;
        } else {
          const existingIndex = cart.findIndex(item => item.product.id === product.id);
          if (existingIndex >= 0) {
            cart[existingIndex].quantity += quantity;
            cart[existingIndex].subtotal = cart[existingIndex].quantity * product.price;
          } else {
            cart.push({
              product,
              quantity,
              subtotal: product.price * quantity,
              discount: 0
            });
            selectedCartIndex = cart.length - 1;
          }
        }
        showToast(`${product.name} - R$ ${(product.price * quantity).toFixed(2)}`, 'success');
        barcodeInputEl.placeholder = "Código de barras, gramatura (ex: 150 *) ou código do produto";
        updateDisplay();
      }
      function addProduct() {
        const input = barcodeInputEl.value.trim();
        if (input) {
          addProductToCart(input);
          barcodeInputEl.value = '';
          barcodeInputEl.focus();
        }
      }
      function showSearchModal() {
        if (!cashOpened) {
          showToast('Caixa não aberto. Abra o caixa para usar atalhos.', 'error');
          return;
        }
        searchModal.classList.remove('hidden');
        searchInput.value = '';
        displaySearchResults('');
        searchInput.focus();
      }
      function hideSearchModal() {
        searchModal.classList.add('hidden');
        barcodeInputEl.focus();
      }
      function displaySearchResults(query) {
        const resultsEl = document.getElementById('searchResults');
        resultsEl.innerHTML = '';
        const products = Object.entries(productsDatabase).map(([id, prod]) => ({
          id,
          ...prod
        }));
        const filtered = products.filter(prod => prod.nome.toLowerCase().includes(query.toLowerCase()) || prod.id.toString().includes(query));
        if (filtered.length === 0) {
          resultsEl.innerHTML = '<p>Nenhum produto encontrado.</p>';
        }
        filtered.forEach(prod => {
          const itemEl = document.createElement('div');
          itemEl.className = 'cart-item';
          itemEl.innerHTML = `
            <div class="cart-item-info">
              <h3>${prod.nome}</h3>
              <div class="cart-item-details">
                Código: ${prod.id} | Unitário: R$ ${prod.preco.toFixed(2)} | Unidade: ${prod.unidade} | Estoque: ${prod.estoque || 0}
              </div>
            </div>
            <button class="btn btn-primary" onclick="selectProduct('${prod.id}', '${prod.unidade}')">Selecionar</button>
          `;
          resultsEl.appendChild(itemEl);
        });
      }
      function selectProduct(code, unit) {
        if (!cashOpened) {
          showToast('Caixa não aberto. Abra o caixa para usar atalhos.', 'error');
          return;
        }
        hideSearchModal();
        let quantity = 1;
        if (unit === 'kilo') {
          const weightStr = prompt('Digite a gramatura em gramas (ex: 150):');
          if (!weightStr) return;
          const weight = parseFloat(weightStr);
          if (isNaN(weight) || weight <= 0) {
            showToast('Gramatura inválida.', 'error');
            return;
          }
          quantity = weight / 1000;
        } else {
          const qtyStr = prompt('Digite a quantidade (ex: 2):', '1');
          if (!qtyStr) return;
          quantity = parseFloat(qtyStr);
          if (isNaN(quantity) || quantity <= 0) {
            showToast('Quantidade inválida.', 'error');
            return;
          }
        }
        const prodData = productsDatabase[code];
        if (!prodData) {
          showToast('Produto não encontrado.', 'error');
          return;
        }
        const product = {
          id: code,
          barcode: code,
          name: prodData.nome,
          price: prodData.preco,
          unit: unit
        };
        const price = product.price * quantity;
        let added = false;
        if (unit !== 'kilo') {
          const existingIndex = cart.findIndex(item => item.product.id === code);
          if (existingIndex >= 0) {
            cart[existingIndex].quantity += quantity;
            cart[existingIndex].subtotal += price;
            added = true;
          }
        }
        if (!added) {
          cart.push({
            product,
            quantity,
            subtotal: price,
            discount: 0
          });
        }
        selectedCartIndex = cart.length - 1;
        showToast(`${product.name} adicionado à venda.`, 'success');
        updateDisplay();
      }
      function updateDisplay() {
        if (cart.length === 0) {
          waitingScreenEl.classList.remove('hidden');
          cartAreaEl.classList.add('hidden');
          finalizeBtn.classList.add('hidden');
          paymentFormEl.classList.add('hidden');
          paymentsCardEl.classList.add('hidden');
          paymentInfoEl.style.display = 'none';
          totalModifiersEl.style.display = 'none';
          payments = [];
          totalDiscount = 0;
          totalAddition = 0;
        } else {
          waitingScreenEl.classList.add('hidden');
          cartAreaEl.classList.remove('hidden');
          finalizeBtn.classList.remove('hidden');
          updateCart();
        }
        updateTotals();
      }
      function updateCart() {
        cartAreaEl.innerHTML = '';
        cart.forEach((item, index) => {
          const itemEl = document.createElement('div');
          const quantityDisplay = item.product.unit === 'kilo' ?
            `${(item.quantity * 1000).toFixed(0)}g` :
            `${item.quantity} un`;
          itemEl.className = `cart-item ${index === selectedCartIndex ? 'selected' : ''}`;
          itemEl.innerHTML = `
            <div class="cart-item-info">
              <h3>${item.product.name}</h3>
              <div class="cart-item-details">
                Código: ${item.product.barcode} | Qtd: ${quantityDisplay} |
                Unitário: R$ ${item.product.price.toFixed(2)}
              </div>
              ${item.discount > 0 ? `<div class="discount-info">Desconto: R$ ${item.discount.toFixed(2)}</div>` : ''}
            </div>
            <div class="cart-item-price">
              R$ ${(item.subtotal - item.discount).toFixed(2)}
            </div>
          `;
          cartAreaEl.appendChild(itemEl);
        });
        if (cart.length > 0 && selectedCartIndex >= 0 && selectedCartIndex < cart.length) {
          const selectedItem = cartAreaEl.children[selectedCartIndex];
          if (selectedItem) {
            selectedItem.scrollIntoView({
              behavior: 'smooth',
              block: 'nearest'
            });
          }
        }
      }
      function getBaseSubtotal() {
        return cart.reduce((sum, item) => sum + item.subtotal - item.discount, 0);
      }
      function getSubtotal() {
        return parseFloat((getBaseSubtotal() - totalDiscount + totalAddition).toFixed(2));
      }
      function getTotalPaid() {
        return parseFloat(payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0).toFixed(2));
      }
      function getRemaining() {
        return parseFloat((getSubtotal() - getTotalPaid()).toFixed(2));
      }
      function updateTotals() {
        const subtotal = getSubtotal();
        const totalPaid = getTotalPaid();
        const remaining = getRemaining();
        totalAmountEl.textContent = `R$ ${subtotal.toFixed(2)}`;
        if (totalDiscount > 0 || totalAddition > 0) {
          totalModifiersEl.style.display = 'block';
          totalDiscountDisplay.textContent = totalDiscount > 0 ? `Desconto Total: R$ ${totalDiscount.toFixed(2)}` : '';
          totalAdditionDisplay.textContent = totalAddition > 0 ? `Acréscimo Total: R$ ${totalAddition.toFixed(2)}` : '';
        } else {
          totalModifiersEl.style.display = 'none';
        }
        if (payments.length > 0) {
          paymentInfoEl.style.display = 'block';
          totalPaidEl.textContent = totalPaid.toFixed(2);
          remainingAmountEl.textContent = remaining.toFixed(2);
          updatePaymentsList();
        } else {
          paymentInfoEl.style.display = 'none';
        }
      }
      function updatePaymentsList() {
        paymentsCardEl.classList.toggle('hidden', payments.length === 0);
        paymentsListEl.innerHTML = '';
        payments.forEach(payment => {
          const paymentEl = document.createElement('div');
          paymentEl.className = 'payment-item';
          paymentEl.innerHTML = `
            <span style="text-transform: capitalize;">${payment.type}</span>
            <span>R$ ${parseFloat(payment.amount).toFixed(2)}</span>
          `;
          paymentsListEl.appendChild(paymentEl);
        });
      }
      function showPaymentForm() {
        if (!cashOpened) {
          showToast('Caixa não aberto. Abra o caixa para iniciar vendas.', 'error');
          return;
        }
        if (cart.length > 0) {
          paymentFormEl.classList.remove('hidden');
          finalizeBtn.classList.add('hidden');
          selectPaymentType('dinheiro');
          const remaining = getRemaining();
          paymentAmountEl.value = remaining.toFixed(2);
          paymentAmountEl.focus();
        }
      }
      function selectPaymentType(type) {
        selectedPaymentType = type;
        const types = ['dinheiro', 'pix', 'credito', 'debito', 'vale-troca'];
        types.forEach(t => {
          const btn = document.getElementById(`btn-${t}`);
          if (btn) btn.className = t === type ? 'btn btn-primary' : 'btn btn-outline';
        });
        paymentAmountEl.readOnly = (type === 'vale-troca');
        paymentAmountEl.focus();
      }
      async function addPayment() {
        let amountStr = paymentAmountEl.value.trim();
        amountStr = amountStr.replace(',', '.');
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) {
          showToast('Insira um valor válido.', 'error');
          return;
        }
        const isCash = selectedPaymentType === 'dinheiro';
        const subtotal = getSubtotal();
        const remaining = getRemaining();
        if (!isCash && amount > remaining + 0.01) {
          showToast('Para pagamentos não em dinheiro, o valor não pode exceder o restante.', 'error');
          return;
        }
        const payment = {
          type: selectedPaymentType.charAt(0).toUpperCase() + selectedPaymentType.slice(1).toLowerCase(),
          amount: amount
        };
        if (selectedPaymentType === 'vale-troca' && currentVoucherCode) {
          payment.voucherCode = currentVoucherCode;
          currentVoucherCode = null;
        }
        payments.push(payment);
        const newRemaining = getRemaining();
        if (amount < remaining) {
          showToast(`Pagamento de R$ ${amount.toFixed(2)} adicionado. Restante: R$ ${newRemaining.toFixed(2)}`, 'success');
          updateTotals();
          paymentAmountEl.value = newRemaining.toFixed(2);
          paymentAmountEl.focus();
        } else {
          let change = amount - remaining;
          showToast(`Pagamento de R$ ${amount.toFixed(2)} adicionado. Troco: R$ ${change > 0 ? change.toFixed(2) : '0.00'}`, 'success');
          const totalPaidAfter = getTotalPaid();
          if (totalPaidAfter >= subtotal - 0.01) {
            try {
              const user = auth.currentUser;
              if (!user) {
                showToast('Usuário não autenticado.', 'error');
                return;
              }
              const updates = {};
              cart.forEach(item => {
                const productCode = item.product.id;
                const currentStock = productsDatabase[productCode]?.estoque || 0;
                const newStock = currentStock - item.quantity;
                updates[`produtos/${user.uid}/${productCode}/estoque`] = newStock;
              });
              const paymentDetails = payments.map(p => `${p.type}: R$ ${p.amount.toFixed(2)}`).join(', ');
              const counterRef = ref(db, `counters/${user.uid}/saleNumber`);
              await runTransaction(counterRef, (current) => {
                return (current || 0) + 1;
              }).then(async (transaction) => {
                const saleNumber = transaction.snapshot.val();
                const saleData = {
                  saleNumber: saleNumber,
                  dataVenda: new Date().toISOString(),
                  valorTotal: subtotal,
                  tipoPagamento: payments.length > 1 ? paymentDetails : `${payments[0].type}: R$ ${payments[0].amount.toFixed(2)}`,
                  pagamentos: payments,
                  descontoTotal: totalDiscount,
                  acrescimoTotal: totalAddition,
                  items: cart.map(item => ({
                    codigo: item.product.barcode,
                    nome: item.product.name,
                    preco: item.subtotal - item.discount,
                    quantidade: item.quantity,
                    unidade: item.product.unit
                  })),
                  observacoes: "Venda PDV",
                  troco: change > 0 ? change : 0
                };
                const baseRef = ref(db, `vendas/${user.uid}`);
                const newSaleRef = push(baseRef);
                await Promise.all([
                  set(newSaleRef, saleData),
                  update(ref(db), updates)
                ]);
                for (const payment of payments) {
                  if (payment.voucherCode) {
                    const voucherRef = ref(db, `valesTroca/${user.uid}/${payment.voucherCode}`);
                    await update(voucherRef, { used: true, usedDate: new Date().toISOString() });
                  }
                }
                const today = new Date().toISOString().split('T')[0];
                const cashRef = ref(db, `cash/${user.uid}/${today}`);
                const cashSnapshot = await get(cashRef);
                let cashData = cashSnapshot.val() || {};
                let salesByPayment = cashData.salesByPayment || {
                  Pix: 0,
                  Dinheiro: 0,
                  Credito: 0,
                  Debito: 0,
                  ValeTroca: 0,
                  Outro: 0
                };
                payments.forEach(p => {
                  const paymentTypeKey = p.type;
                  salesByPayment[paymentTypeKey] = (salesByPayment[paymentTypeKey] || 0) + p.amount;
                });
                if (change > 0) {
                  salesByPayment['Dinheiro'] -= change;
                }
                cashData.salesByPayment = salesByPayment;
                await update(cashRef, cashData);
                printSaleReceipt(saleData, amount);
                showToast(`Venda finalizada! Total: R$ ${subtotal.toFixed(2)}`, 'success');
                if (change > 0) {
                  showChangeModal(change);
                } else {
                  cancelSale();
                }
              });
            } catch (error) {
              showToast(`Erro ao finalizar venda: ${error.message}`, 'error');
              console.error(error);
            }
          } else {
            updateTotals();
            paymentAmountEl.value = newRemaining.toFixed(2);
            paymentAmountEl.focus();
          }
        }
      }
      function printSaleReceipt(sale, amountGiven) {
        const {
          jsPDF
        } = window.jspdf;
        const doc = new jsPDF();
        const shopName = "VIDA SAUDAVEL";
        const dateTime = new Date(sale.dataVenda).toLocaleString('pt-BR');
        let yPos = 10;
        const margin = 10;
        const lineHeight = 7;
        doc.setFontSize(14);
        doc.text(shopName, doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        yPos += lineHeight;
        doc.setFontSize(10);
        doc.text(`Venda Nº: ${sale.saleNumber || 'N/A'}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Data: ${dateTime}`, margin, yPos);
        yPos += lineHeight;
        doc.text("-----------------------------------------", margin, yPos);
        yPos += lineHeight;
        doc.text("ITENS DA VENDA:", margin, yPos);
        yPos += lineHeight;
        sale.items.forEach(item => {
          const quantidadeDisplay = item.unidade === 'kilo' ?
            `${(item.quantidade * 1000).toFixed(0)}g` :
            `${item.quantidade} un`;
          doc.text(`${item.nome} (${quantidadeDisplay})`, margin, yPos);
          doc.text(`R$ ${item.preco.toFixed(2).replace('.', ',')}`, doc.internal.pageSize.getWidth() - margin, yPos, {
            align: 'right'
          });
          yPos += lineHeight;
        });
        doc.text("-----------------------------------------", margin, yPos);
        yPos += lineHeight;
        doc.setFontSize(12);
        if (sale.descontoTotal > 0) {
          doc.text(`Desconto Total: R$ ${sale.descontoTotal.toFixed(2).replace('.', ',')}`, margin, yPos);
          yPos += lineHeight;
        }
        if (sale.acrescimoTotal > 0) {
          doc.text(`Acréscimo Total: R$ ${sale.acrescimoTotal.toFixed(2).replace('.', ',')}`, margin, yPos);
          yPos += lineHeight;
        }
        doc.text(`TOTAL: R$ ${sale.valorTotal.toFixed(2).replace('.', ',')}`, margin, yPos);
        yPos += lineHeight;
        doc.text("Pagamentos:", margin, yPos);
        yPos += lineHeight;
        if (sale.pagamentos && Array.isArray(sale.pagamentos)) {
          sale.pagamentos.forEach(pagamento => {
            doc.text(`${pagamento.type}: R$ ${parseFloat(pagamento.amount).toFixed(2).replace('.', ',')}`, margin, yPos);
            yPos += lineHeight;
          });
        } else {
          doc.text(`Pagamento: ${sale.tipoPagamento}`, margin, yPos);
          yPos += lineHeight;
        }
        if (sale.troco > 0) {
          const lastPayment = sale.pagamentos[sale.pagamentos.length - 1];
          if (lastPayment.type.toLowerCase() === 'dinheiro') {
            doc.text(`Valor Recebido (Dinheiro): R$ ${parseFloat(lastPayment.amount).toFixed(2).replace('.', ',')}`, margin, yPos);
            yPos += lineHeight;
          }
          doc.text(`Troco: R$ ${sale.troco.toFixed(2).replace('.', ',')}`, margin, yPos);
          yPos += lineHeight;
        }
        doc.text("-----------------------------------------", margin, yPos);
        yPos += lineHeight;
        doc.setFontSize(10);
        doc.text("Obrigado pela preferência!", doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        doc.save(`venda_${new Date(sale.dataVenda).getTime()}.pdf`);
      }
      function cancelPayment() {
        paymentFormEl.classList.add('hidden');
        if (cart.length > 0) {
          finalizeBtn.classList.remove('hidden');
        }
        paymentAmountEl.value = '';
        selectPaymentType('dinheiro');
        barcodeInputEl.focus();
      }
      function cancelSale() {
        cart = [];
        payments = [];
        selectedCartIndex = 0;
        tempWeight = null;
        totalDiscount = 0;
        totalAddition = 0;
        currentVoucherCode = null;
        barcodeInputEl.placeholder = "Código de barras, gramatura (ex: 150 *) ou código do produto";
        updateDisplay();
        showToast('Venda cancelada', 'warning');
        barcodeInputEl.focus();
      }
      function removeItem() {
        if (cart.length > 0 && selectedCartIndex < cart.length) {
          cart.splice(selectedCartIndex, 1);
          selectedCartIndex = Math.max(0, selectedCartIndex - 1);
          updateDisplay();
          showToast('Item removido', 'warning');
        }
      }
      function applyDiscount() {
        if (cart.length > 0 && selectedCartIndex < cart.length) {
          const input = prompt('Digite o desconto no item (ex: 10 para R$10 ou 10% para 10%):');
          if (input) {
            let trimmedInput = input.trim();
            let discount;
            if (trimmedInput.endsWith('%')) {
              const percent = parseFloat(trimmedInput.slice(0, -1));
              if (!isNaN(percent) && percent >= 0 && percent <= 100) {
                discount = cart[selectedCartIndex].subtotal * (percent / 100);
              } else {
                showToast('Percentual de desconto inválido (0-100%).', 'error');
                return;
              }
            } else {
              discount = parseFloat(trimmedInput);
              if (isNaN(discount) || discount < 0 || discount > cart[selectedCartIndex].subtotal) {
                showToast('Valor de desconto inválido (não pode exceder o subtotal do item).', 'error');
                return;
              }
            }
            cart[selectedCartIndex].discount = parseFloat(discount.toFixed(2));
            updateDisplay();
            showToast(`Desconto aplicado: R$ ${discount.toFixed(2)}`, 'success');
          }
        }
      }
      function applyAddition() {
        if (cart.length > 0 && selectedCartIndex < cart.length) {
          const input = prompt('Digite o acréscimo no item (ex: 10 para R$10 ou 10% para 10%):');
          if (input) {
            let trimmedInput = input.trim();
            let addition;
            if (trimmedInput.endsWith('%')) {
              const percent = parseFloat(trimmedInput.slice(0, -1));
              if (!isNaN(percent) && percent >= 0) {
                addition = cart[selectedCartIndex].subtotal * (percent / 100);
              } else {
                showToast('Percentual de acréscimo inválido.', 'error');
                return;
              }
            } else {
              addition = parseFloat(trimmedInput);
              if (isNaN(addition) || addition < 0) {
                showToast('Valor de acréscimo inválido.', 'error');
                return;
              }
            }
            cart[selectedCartIndex].subtotal += parseFloat(addition.toFixed(2));
            updateDisplay();
            showToast(`Acréscimo aplicado: R$ ${addition.toFixed(2)}`, 'success');
          }
        }
      }
      function applyTotalDiscount() {
        if (cart.length > 0) {
          const input = prompt('Digite o desconto total (ex: 10 para R$10 ou 10% para 10%):');
          if (input) {
            let trimmedInput = input.trim();
            let discount;
            if (trimmedInput.endsWith('%')) {
              const percent = parseFloat(trimmedInput.slice(0, -1));
              if (!isNaN(percent) && percent >= 0 && percent <= 100) {
                discount = getBaseSubtotal() * (percent / 100);
              } else {
                showToast('Percentual de desconto inválido (0-100%).', 'error');
                return;
              }
            } else {
              discount = parseFloat(trimmedInput);
              if (isNaN(discount) || discount < 0 || discount > getBaseSubtotal()) {
                showToast('Valor de desconto inválido (não pode exceder o subtotal base).', 'error');
                return;
              }
            }
            totalDiscount = parseFloat(discount.toFixed(2));
            updateDisplay();
            if (!paymentFormEl.classList.contains('hidden')) {
              paymentAmountEl.value = getRemaining().toFixed(2);
            }
            showToast(`Desconto total aplicado: R$ ${discount.toFixed(2)}`, 'success');
          }
        }
      }
      function applyTotalAddition() {
        if (cart.length > 0) {
          const input = prompt('Digite o acréscimo total (ex: 10 para R$10 ou 10% para 10%):');
          if (input) {
            let trimmedInput = input.trim();
            let addition;
            if (trimmedInput.endsWith('%')) {
              const percent = parseFloat(trimmedInput.slice(0, -1));
              if (!isNaN(percent) && percent >= 0) {
                addition = getBaseSubtotal() * (percent / 100);
              } else {
                showToast('Percentual de acréscimo inválido.', 'error');
                return;
              }
            } else {
              addition = parseFloat(trimmedInput);
              if (isNaN(addition) || addition < 0) {
                showToast('Valor de acréscimo inválido.', 'error');
                return;
              }
            }
            totalAddition = parseFloat(addition.toFixed(2));
            updateDisplay();
            if (!paymentFormEl.classList.contains('hidden')) {
              paymentAmountEl.value = getRemaining().toFixed(2);
            }
            showToast(`Acréscimo total aplicado: R$ ${addition.toFixed(2)}`, 'success');
          }
        }
      }
      function registerUser() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          showToast('Por favor, preencha email e senha.', 'error');
          return;
        }
        if (password.length < 6) {
          showToast('A senha deve ter pelo menos 6 caracteres.', 'error');
          return;
        }
        showToast('Registrando usuário...', 'warning');
        createUserWithEmailAndPassword(auth, email, password)
          .then(() => {
            showToast('Usuário registrado com sucesso!', 'success');
            emailInput.value = '';
            passwordInput.value = '';
          })
          .catch(err => {
            let message = 'Erro ao registrar usuário.';
            if (err.code === 'auth/email-already-in-use') {
              message = 'Email já está em uso.';
            } else if (err.code === 'auth/invalid-email') {
              message = 'Email inválido.';
            }
            showToast(message, 'error');
            console.error('Erro no registro:', err);
          });
      }
      function loginUser() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
          showToast('Por favor, preencha email e senha.', 'error');
          return;
        }
        showToast('Fazendo login...', 'warning');
        signInWithEmailAndPassword(auth, email, password)
          .then(() => {
            showToast('Login realizado com sucesso!', 'success');
            emailInput.value = '';
            passwordInput.value = '';
            setTimeout(() => {
              loadProductsFromDatabase();
              loadCashData();
              barcodeInputEl.focus();
            }, 500);
          })
          .catch(err => {
            let message = 'Erro ao fazer login.';
            if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
              message = 'Email ou senha inválidos.';
            } else if (err.code === 'auth/invalid-email') {
              message = 'Email inválido.';
            }
            showToast(message, 'error');
            console.error('Erro no login:', err);
          });
      }
      function openCash() {
        const name = prompt('Nome do operador que abre o caixa:');
        if (!name) return;
        const initialStr = prompt('Suprimento inicial (R$):');
        const initial = parseFloat(initialStr.replace(',', '.'));
        if (isNaN(initial) || initial < 0) {
          showToast('Valor inicial inválido.', 'error');
          return;
        }
        const today = new Date().toISOString().split('T')[0];
        const cashRef = ref(db, `cash/${auth.currentUser.uid}/${today}`);
        set(cashRef, {
          openerName: name,
          initial: initial,
          openingTimestamp: new Date().toLocaleString('pt-BR'),
          operations: [],
          salesByPayment: {
            Pix: 0,
            Dinheiro: 0,
            Credito: 0,
            Debito: 0,
            ValeTroca: 0,
            Outro: 0
          }
        }).then(() => {
          showToast('Caixa aberto com sucesso!', 'success');
          printCashOperation('Abertura de Caixa', initial, name, 'Inicial');
        }).catch(err => showToast(`Erro ao abrir caixa: ${err.message}`, 'error'));
      }
      function registerSangria() {
        if (!cashOpened) {
          showToast('Caixa não aberto.', 'error');
          return;
        }
        const amountStr = prompt('Valor da sangria (R$):');
        const amount = parseFloat(amountStr.replace(',', '.'));
        if (isNaN(amount) || amount <= 0) {
          showToast('Valor inválido.', 'error');
          return;
        }
        const note = prompt('Observação (opcional):') || '';
        const operation = {
          type: 'sangria',
          amount: -amount,
          note: note,
          timestamp: new Date().toLocaleString('pt-BR')
        };
        cashOperations.push(operation);
        saveCashOperations();
        showToast('Sangria registrada!', 'success');
        printCashOperation('Sangria', amount, '', note);
      }
      function registerSuprimento() {
        if (!cashOpened) {
          showToast('Caixa não aberto.', 'error');
          return;
        }
        const amountStr = prompt('Valor do suprimento (R$):');
        const amount = parseFloat(amountStr.replace(',', '.'));
        if (isNaN(amount) || amount <= 0) {
          showToast('Valor inválido.', 'error');
          return;
        }
        const note = prompt('Observação (opcional):') || '';
        const operation = {
          type: 'suprimento',
          amount: amount,
          note: note,
          timestamp: new Date().toLocaleString('pt-BR')
        };
        cashOperations.push(operation);
        saveCashOperations();
        showToast('Suprimento registrado!', 'success');
        printCashOperation('Suprimento', amount, '', note);
      }
      async function closeCash() {
        if (!cashOpened) {
          showToast('Caixa não aberto.', 'error');
          return;
        }
        const name = prompt('Nome do operador que fecha o caixa:');
        if (!name) return;
        const finalCountStr = prompt('Contagem final de dinheiro (R$):');
        const finalCount = parseFloat(finalCountStr.replace(',', '.'));
        if (isNaN(finalCount) || finalCount < 0) {
          showToast('Valor inválido.', 'error');
          return;
        }
        let totalCashOperations = cashOperations.reduce((sum, op) => sum + op.amount, 0);
        let expectedCash = initialCash + dailySalesByPayment.Dinheiro + totalCashOperations;
        let difference = finalCount - expectedCash;
        const confirmMsg = `Caixa esperado: R$ ${expectedCash.toFixed(2)}\nContagem final: R$ ${finalCount.toFixed(2)}\nDiferença: R$ ${difference.toFixed(2)}\nConfirmar fechamento?`;
        if (confirm(confirmMsg)) {
          const today = new Date().toISOString().split('T')[0];
          const cashRef = ref(db, `cash/${auth.currentUser.uid}/${today}`);
          update(cashRef, {
            finalCash: finalCount,
            difference: difference,
            closerName: name,
            closingTimestamp: new Date().toLocaleString('pt-BR')
          }).then(() => {
            showToast('Caixa fechado com sucesso!', 'success');
            printClosingReport(expectedCash, finalCount, difference, name);
          }).catch(err => showToast(`Erro ao fechar caixa: ${err.message}`, 'error'));
        }
      }
      function saveCashOperations() {
        const user = auth.currentUser;
        if (user) {
          const today = new Date().toISOString().split('T')[0];
          const cashRef = ref(db, `cash/${user.uid}/${today}`);
          update(cashRef, {
            operations: cashOperations,
            salesByPayment: dailySalesByPayment
          });
        }
      }
      function printCashOperation(type, amount, name, note) {
        const {
          jsPDF
        } = window.jspdf;
        const doc = new jsPDF();
        const shopName = "VIDA SAUDAVEL";
        const dateTime = new Date().toLocaleString('pt-BR');
        let yPos = 10;
        const margin = 10;
        const lineHeight = 7;
        doc.setFontSize(14);
        doc.text(shopName, doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        yPos += lineHeight;
        doc.setFontSize(12);
        doc.text(type, doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        yPos += lineHeight;
        doc.setFontSize(10);
        doc.text(`Data: ${dateTime}`, margin, yPos);
        yPos += lineHeight;
        doc.text("-----------------------------------------", margin, yPos);
        yPos += lineHeight;
        doc.text(`Valor: R$ ${amount.toFixed(2).replace('.', ',')}`, margin, yPos);
        yPos += lineHeight;
        if (name) doc.text(`Operador: ${name}`, margin, yPos);
        yPos += lineHeight;
        if (note) doc.text(`Observação: ${note}`, margin, yPos);
        yPos += lineHeight;
        doc.text("-----------------------------------------", margin, yPos);
        doc.save(`${type.toLowerCase()}_${new Date().getTime()}.pdf`);
      }
      function printClosingReport(expected, final, diff, name) {
        const {
          jsPDF
        } = window.jspdf;
        const doc = new jsPDF();
        const shopName = "VIDA SAUDAVEL";
        const dateTime = new Date().toLocaleString('pt-BR');
        let yPos = 10;
        const margin = 10;
        const lineHeight = 7;
        doc.setFontSize(14);
        doc.text(shopName, doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        yPos += lineHeight;
        doc.setFontSize(12);
        doc.text('Fechamento de Caixa', doc.internal.pageSize.getWidth() / 2, yPos, {
          align: 'center'
        });
        yPos += lineHeight;
        doc.setFontSize(10);
        doc.text(`Data: ${dateTime}`, margin, yPos);
        yPos += lineHeight;
        doc.text("-----------------------------------------", margin, yPos);
        yPos += lineHeight;
        doc.text(`Caixa esperado: R$ ${expected.toFixed(2).replace('.', ',')}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Contagem final: R$ ${final.toFixed(2).replace('.', ',')}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Diferença: R$ ${diff.toFixed(2).replace('.', ',')}`, margin, yPos);
        yPos += lineHeight;
        doc.text(`Fechado por: ${name}`, margin, yPos);
        yPos += lineHeight;
        doc.text("-----------------------------------------", margin, yPos);
        doc.save(`fechamento_caixa_${new Date().getTime()}.pdf`);
      }
      function showChangeModal(change) {
        changeAmountEl.textContent = `R$ ${change.toFixed(2)}`;
        changeModal.classList.remove('hidden');
      }
      function closeChangeModal() {
        changeModal.classList.add('hidden');
        cancelSale();
      }
      ['dinheiro', 'pix', 'credito', 'debito'].forEach(type => {
        const btn = document.getElementById(`btn-${type}`);
        btn.addEventListener('click', () => selectPaymentType(type));
      });
      document.getElementById('btn-vale-troca').addEventListener('click', async () => {
        const code = prompt('Digite o código do vale troca:');
        if (!code) return;
        try {
          const voucherRef = ref(db, `valesTroca/${auth.currentUser.uid}/${code.trim()}`);
          const snapshot = await get(voucherRef);
          if (!snapshot.exists()) {
            showToast('Código inválido.', 'error');
            return;
          }
          const voucher = snapshot.val();
          if (voucher.used) {
            showToast('Vale troca já utilizado.', 'error');
            return;
          }
          currentVoucherCode = code.trim();
          paymentAmountEl.value = voucher.value.toFixed(2);
          selectPaymentType('vale-troca');
        } catch (err) {
          showToast('Erro ao verificar vale troca.', 'error');
        }
      });
      confirmPaymentBtn.addEventListener('click', addPayment);
      cancelPaymentBtn.addEventListener('click', cancelPayment);
      totalDiscountBtn.addEventListener('click', applyTotalDiscount);
      totalAdditionBtn.addEventListener('click', applyTotalAddition);
      registerBtn.addEventListener('click', registerUser);
      loginBtn.addEventListener('click', loginUser);
      logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => {
          showToast('Logout realizado!', 'warning');
          emailInput.focus();
        });
      });
      openCashBtn.addEventListener('click', openCash);
      sangriaBtn.addEventListener('click', registerSangria);
      suprimentoBtn.addEventListener('click', registerSuprimento);
      closeCashBtn.addEventListener('click', closeCash);
      closeSearchBtn.addEventListener('click', hideSearchModal);
      searchInput.addEventListener('keyup', (e) => {
        displaySearchResults(e.target.value);
      });
      searchModal.addEventListener('click', (e) => {
        if (e.target === searchModal) {
          hideSearchModal();
        }
      });
      closeChangeBtn.addEventListener('click', closeChangeModal);
      changeModal.addEventListener('click', (e) => {
        if (e.target === changeModal) {
          closeChangeModal();
        }
      });
      viewSalesBtn.addEventListener('click', showSalesSection);
      function showSalesSection() {
        cartAreaEl.classList.add('hidden');
        inputAreaEl.classList.add('hidden');
        salesSection.classList.remove('hidden');
        waitingScreenEl.classList.add('hidden');
        loadAllSalesAndFilter();
      }
      function hideSalesSection() {
        salesSection.classList.add('hidden');
        cartAreaEl.classList.remove('hidden');
        inputAreaEl.classList.remove('hidden');
        if (cart.length === 0) {
          waitingScreenEl.classList.remove('hidden');
        }
        barcodeInputEl.focus();
      }
      function loadAllSalesAndFilter() {
        const user = auth.currentUser;
        if (user) {
          const vendasRef = ref(db, `vendas/${user.uid}`);
          onValue(vendasRef, snapshot => {
            allSalesData = [];
            if (snapshot.exists()) {
              const data = snapshot.val();
              Object.entries(data).forEach(([key, item]) => {
                allSalesData.push({
                  id: key,
                  ...item
                });
              });
            }
            applyFiltersAndDisplaySales();
          }, { onlyOnce: false });
        }
      }
      window.applyFiltersAndDisplaySales = () => {
        const container = document.getElementById("saleList");
        container.innerHTML = "";
        let currentTotalSales = 0;
        const filterDateStartStr = document.getElementById("filterDateStart").value;
        const filterDateEndStr = document.getElementById("filterDateEnd").value;
        const filterPaymentType = document.getElementById("filterPaymentType").value;
        const filterDateStart = filterDateStartStr ? new Date(filterDateStartStr + 'T00:00:00') : null;
        const filterDateEnd = filterDateEndStr ? new Date(filterDateEndStr + 'T23:59:59') : null;
        filteredSalesData = allSalesData.filter(sale => {
          const saleDate = new Date(sale.dataVenda);
          const matchesDate = (!filterDateStart || saleDate >= filterDateStart) && (!filterDateEnd || saleDate <= filterDateEnd);
          const matchesPaymentType = (filterPaymentType === "Todos" || sale.tipoPagamento === filterPaymentType);
          return matchesDate && matchesPaymentType;
        });
        if (filteredSalesData.length > 0) {
          filteredSalesData.forEach(item => {
            currentTotalSales += item.valorTotal;
            const div = document.createElement("div");
            const itemsList = item.items && item.items.length > 0 ?
              item.items.map(i => {
                const quantidadeDisplay = i.unidade === 'kilo' ?
                  `${(i.quantidade * 1000).toFixed(0)}g` :
                  `${i.quantidade} un`;
                return `<li>${i.nome} (${quantidadeDisplay}, R$ ${i.preco.toFixed(2).replace('.', ',')})</li>`;
              }).join('') : '';
            div.innerHTML = `
              <strong>Venda Nº:</strong> ${item.saleNumber || 'N/A'}<br>
              <strong>Data/Hora:</strong> ${item.dataVenda ? new Date(item.dataVenda).toLocaleString('pt-BR') : 'N/A'}<br>
              <strong>Valor Total:</strong> R$ ${item.valorTotal ? item.valorTotal.toFixed(2).replace('.', ',') : '0,00'}<br>
              <strong>Tipo de Pagamento:</strong> ${item.tipoPagamento}<br>
              <strong>Obs.:</strong> ${item.observacoes || 'N/A'}<br>
              ${itemsList ? `<strong>Itens:</strong><ul>${itemsList}</ul>` : ''}
              <button class="btn btn-outline" onclick="reimprimirVenda('${item.id}')">Reimprimir</button>
              <button class="btn btn-outline" onclick="excluirVenda('${item.id}')">Excluir</button>
            `;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = "Nenhuma venda encontrada com os filtros aplicados.";
        }
        document.getElementById("totalSalesValue").textContent = `R$ ${currentTotalSales.toFixed(2).replace('.', ',')}`;
      };
      window.excluirVenda = async (id) => {
        const confirmacao = confirm("Tem certeza que deseja excluir esta venda? Isso reverterá o estoque.");
        if (!confirmacao) return;
        const user = auth.currentUser;
        if (user) {
          const vendaRef = ref(db, `vendas/${user.uid}/${id}`);
          const snapshot = await get(vendaRef);
          if (snapshot.exists()) {
            const sale = snapshot.val();
            const updates = {};
            sale.items.forEach(item => {
              const productCode = item.codigo.startsWith('2') && item.codigo.length === 13 ? item.codigo.slice(1, 7) : item.codigo;
              const currentStock = productsDatabase[productCode]?.estoque || 0;
              const newStock = currentStock + item.quantidade;
              updates[`produtos/${user.uid}/${productCode}/estoque`] = newStock;
            });
            await update(ref(db), updates);
            await remove(vendaRef);
            showToast('Venda excluída e estoque revertido!', 'success');
            applyFiltersAndDisplaySales();
          }
        }
      };
      window.reimprimirVenda = async (id) => {
        const user = auth.currentUser;
        if (user) {
          const vendaRef = ref(db, `vendas/${user.uid}/${id}`);
          const snapshot = await get(vendaRef);
          if (snapshot.exists()) {
            const saleData = snapshot.val();
            // Para reimprimir, precisamos simular o amountGiven, mas como não há, assumimos 0 ou o valor total se dinheiro
            const amountGiven = saleData.pagamentos && saleData.pagamentos[saleData.pagamentos.length - 1]?.type === 'Dinheiro' ? saleData.pagamentos[saleData.pagamentos.length - 1].amount : 0;
            printSaleReceipt(saleData, amountGiven);
            showToast('Cupom reimpresso!', 'success');
          } else {
            showToast('Venda não encontrada.', 'error');
          }
        }
      };
      onAuthStateChanged(auth, user => {
        console.log('Estado de autenticação:', user ? `Usuário logado: ${user.uid}` : 'Nenhum usuário logado');
        if (user) {
          authSection.classList.add('hidden');
          header.classList.remove('hidden');
          mainContainer.classList.remove('hidden');
          loadProductsFromDatabase();
          loadCashData();
          loadAllSalesAndFilter();
          updateTime();
          setTimeout(() => barcodeInputEl.focus(), 1000);
        } else {
          authSection.classList.remove('hidden');
          header.classList.add('hidden');
          mainContainer.classList.add('hidden');
          cart = [];
          payments = [];
          productsDatabase = {};
          totalDiscount = 0;
          totalAddition = 0;
          cashOpened = false;
          updateDisplay();
          emailInput.focus();
        }
      });
      document.addEventListener('keydown', function(e) {
        if (!cashOpened && ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9'].includes(e.key)) {
          e.preventDefault();
          showToast('Caixa não aberto. Abra o caixa para usar atalhos.', 'error');
          return;
        }
        if (e.key === 'F1') {
          e.preventDefault();
          cancelSale();
        }
        if (e.key === 'F2') {
          e.preventDefault();
          removeItem();
        }
        if (e.key === 'F3') {
          e.preventDefault();
          applyDiscount();
        }
        if (e.key === 'F4') {
          e.preventDefault();
          applyAddition();
        }
        if (e.key === 'F5') {
          e.preventDefault();
          showPaymentForm();
        }
        if (e.key === 'F6') {
          e.preventDefault();
          applyTotalDiscount();
        }
        if (e.key === 'F7') {
          e.preventDefault();
          applyTotalAddition();
        }
        if (e.key === 'F8') {
          e.preventDefault();
          showSearchModal();
        }
        if (e.key === 'F9') {
          e.preventDefault();
          if (salesSection.classList.contains('hidden')) {
            showSalesSection();
          } else {
            hideSalesSection();
          }
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedCartIndex = Math.max(0, selectedCartIndex - 1);
          updateCart();
        }
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedCartIndex = Math.min(cart.length - 1, selectedCartIndex + 1);
          updateCart();
        }
        if (e.key === 'Enter') {
          if (document.activeElement === barcodeInputEl) {
            e.preventDefault();
            addProduct();
          } else if (document.activeElement === paymentAmountEl) {
            e.preventDefault();
            addPayment();
          } else if (document.activeElement === emailInput || document.activeElement === passwordInput) {
            e.preventDefault();
            loginUser();
          } else if (!changeModal.classList.contains('hidden')) {
            e.preventDefault();
            closeChangeModal();
          }
        }
        if (e.key === 'Escape') {
          e.preventDefault();
          if (!paymentFormEl.classList.contains('hidden')) {
            cancelPayment();
          } else if (!searchModal.classList.contains('hidden')) {
            hideSearchModal();
          } else if (!changeModal.classList.contains('hidden')) {
            closeChangeModal();
          } else if (!salesSection.classList.contains('hidden')) {
            hideSalesSection();
          }
        }
      });
      barcodeInputEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          addProduct();
        }
      });
      updateTime();
      setInterval(updateTime, 1000);
      setInterval(() => {
        if (document.activeElement !== paymentAmountEl &&
          document.activeElement !== emailInput &&
          document.activeElement !== passwordInput &&
          document.activeElement !== searchInput &&
          paymentFormEl.classList.contains('hidden') &&
          searchModal.classList.contains('hidden') &&
          changeModal.classList.contains('hidden') &&
          salesSection.classList.contains('hidden') &&
          auth.currentUser) {
          barcodeInputEl.focus();
        }
      }, 100);
    </script>
</body>
</html>
